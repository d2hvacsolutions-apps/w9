<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D2 HVAC Solutions - Contractor Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Print Styles */
        @media print {
            body { background: white; }
            #sidebar, #login-screen, .no-print, #edit-c-modal, #public-onboard-view { display: none !important; }
            #main-content { margin: 0; padding: 0; width: 100%; height: auto; overflow: visible; }
            .card { box-shadow: none; border: none; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #ddd; padding: 8px; }
            .print-header { display: block !important; margin-bottom: 20px; }
        }
        .print-header { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans h-screen flex overflow-hidden">

    <!-- PUBLIC ONBOARDING VIEW (Hidden by default) -->
    <div id="public-onboard-view" class="fixed inset-0 z-[60] bg-slate-100 overflow-y-auto hidden">
        <div class="min-h-screen flex flex-col items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-8 border border-slate-200">
                <div class="flex flex-col items-center mb-8 border-b border-slate-100 pb-6">
                    <img src="logo-D2-HVAC-Solutions-preto.png" alt="D2 HVAC Logo" class="w-40 mb-4 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="w-16 h-16 bg-blue-600 rounded-xl hidden items-center justify-center text-white mx-auto">
                        <i data-lucide="building-2" class="w-10 h-10"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-slate-800 mt-4">Contractor Registration</h1>
                    <p class="text-slate-500 text-center mt-2">Please fill out your business details and attach your W-9 form.</p>
                </div>

                <form id="public-form" onsubmit="handlePublicSubmit(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Business Name <span class="text-red-500">*</span></label>
                            <input type="text" id="pb-name" required class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Contact Person</label>
                            <input type="text" id="pb-contact" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">EIN / SSN <span class="text-red-500">*</span></label>
                            <input type="text" id="pb-ein" required class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 font-mono">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Email Address</label>
                            <input type="email" id="pb-email" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Phone Number</label>
                            <input type="text" id="pb-phone" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Mailing Address <span class="text-red-500">*</span></label>
                            <input type="text" id="pb-address" required class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                        <label class="block text-sm font-bold text-blue-900 mb-3">Upload W-9 Form (PDF or Image)</label>
                        <input type="file" id="pb-file" accept="image/*,.pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer bg-white rounded-lg border border-blue-100">
                        <p class="text-xs text-blue-400 mt-2">Max file size: 5MB (Storage) or 1MB (Database Fallback).</p>
                    </div>

                    <button type="submit" id="btn-public-submit" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-black shadow-lg transform transition-all hover:-translate-y-1">
                        Submit Registration
                    </button>
                </form>

                <div id="public-success" class="hidden text-center py-12">
                    <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="check" class="w-10 h-10"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Registration Successful!</h2>
                    <p class="text-slate-500">Thank you. Your information has been securely received by D2 HVAC Solutions.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div class="flex flex-col items-center mb-6">
                <!-- LOGO INSERTION -->
                <div class="w-32 mb-6">
                    <img src="logo-D2-HVAC-Solutions-preto.png" alt="D2 HVAC Logo" class="w-full h-auto object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="w-16 h-16 bg-blue-600 rounded-xl hidden items-center justify-center text-white mx-auto">
                        <i data-lucide="building-2" class="w-10 h-10"></i>
                    </div>
                </div>
                <h1 class="text-2xl font-bold text-slate-800">Contractor Portal</h1>
                <p class="text-slate-500 text-sm">Authorized Personnel Only</p>
            </div>
            
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email Address</label>
                    <input type="email" id="email" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="admin@d2hvac.com" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="••••••••" required>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden">Invalid credentials. Access denied.</div>
                <button type="submit" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-blue-600/20">
                    Sign In
                </button>
            </form>
            <div class="mt-6 text-center text-xs text-slate-400">
                &copy; 2026 D2 HVAC Solutions. Secured System.
            </div>
        </div>
    </div>

    <!-- EDIT CONTRACTOR MODAL -->
    <div id="edit-c-modal" class="fixed inset-0 z-40 bg-slate-900/50 hidden flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 text-blue-600 p-2 rounded-lg">
                        <i data-lucide="user-cog" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-xl text-slate-800">Contractor Details</h3>
                        <p class="text-xs text-slate-500">View and edit information</p>
                    </div>
                </div>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600 bg-slate-50 hover:bg-slate-100 p-2 rounded-full transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <form id="edit-c-form" onsubmit="handleUpdateContractor(event)" class="p-6 space-y-5">
                <input type="hidden" id="ec-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Business Name</label>
                        <input type="text" id="ec-name" required class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Contact Person</label>
                        <input type="text" id="ec-contact" class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">EIN / SSN</label>
                        <input type="text" id="ec-ein" required class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all bg-slate-50 font-mono text-slate-700">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                        <input type="email" id="ec-email" class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Phone</label>
                        <input type="text" id="ec-phone" class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Mailing Address</label>
                    <input type="text" id="ec-address" required class="w-full px-3 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-3">W-9 Document Management</label>
                    
                    <div id="ec-current-w9" class="flex items-center gap-4 mb-4 bg-white p-3 rounded-lg border border-slate-200 shadow-sm hidden">
                        <div class="bg-red-50 text-red-600 p-3 rounded-lg">
                            <i data-lucide="file-text" class="w-6 h-6"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-slate-800">W-9 File Available</p>
                            <p class="text-xs text-slate-500">Stored securely.</p>
                        </div>
                        <a id="ec-download-link" href="#" target="_blank" class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 hover:text-blue-600 px-3 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition-colors">
                            <i data-lucide="download" class="w-4 h-4"></i> Download/Print
                        </a>
                    </div>

                    <div id="ec-no-w9" class="flex items-center gap-2 text-sm text-slate-500 mb-4 hidden px-2">
                        <i data-lucide="alert-circle" class="w-4 h-4"></i> No W-9 currently uploaded.
                    </div>

                    <div class="border-t border-slate-200 pt-3">
                         <p class="text-xs text-slate-400 mb-2 font-bold">Upload New File (Replaces Current):</p>
                         <input type="file" id="ec-new-file" accept="image/*,.pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer">
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 pt-4 border-t border-slate-100">
                    <button type="button" onclick="handleDeleteFromModal()" class="text-red-500 hover:text-red-700 text-sm font-bold flex items-center gap-2 px-2 py-1 hover:bg-red-50 rounded transition-colors w-full sm:w-auto justify-center">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Delete Contractor
                    </button>
                    <div class="flex gap-3 w-full sm:w-auto">
                        <button type="button" onclick="closeEditModal()" class="flex-1 sm:flex-none px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg font-medium transition-colors">Cancel</button>
                        <button type="submit" id="btn-update-c" class="flex-1 sm:flex-none bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-lg shadow-blue-600/20 transition-all flex justify-center items-center gap-2">
                            <i data-lucide="save" class="w-4 h-4"></i> Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="w-64 bg-slate-900 text-slate-300 flex-shrink-0 flex flex-col hidden h-full">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
             <div class="w-10 h-10 bg-white rounded-lg p-1 flex items-center justify-center">
                <img src="logo-D2-HVAC-Solutions-preto.png" alt="Logo" class="max-w-full max-h-full" onerror="this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\'building-2\' class=\'text-blue-600\'></i>'">
            </div>
            <div>
                <h1 class="font-bold text-white leading-tight">D2 HVAC</h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest">Admin Portal</p>
            </div>
        </div>

        <nav class="flex-1 p-4 space-y-2">
            <button onclick="router('dashboard')" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-white bg-blue-600 shadow-lg">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="router('contractors')" id="nav-contractors" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all">
                <i data-lucide="users" class="w-5 h-5"></i> Contractors
            </button>
            <button onclick="router('payments')" id="nav-payments" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all">
                <i data-lucide="dollar-sign" class="w-5 h-5"></i> Payments
            </button>
            <button onclick="router('reports')" id="nav-reports" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all">
                <i data-lucide="file-bar-chart" class="w-5 h-5"></i> 1099 Reports
            </button>
            <button onclick="router('users')" id="nav-users" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all">
                <i data-lucide="user-plus" class="w-5 h-5"></i> Users
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-8 h-8 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center font-bold text-xs">DF</div>
                <div>
                    <p class="text-xs font-bold text-white">Dante Frota</p>
                    <p class="text-[10px] text-slate-500">Admin</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-xs text-red-400 hover:text-red-300 transition-colors">
                <i data-lucide="log-out" class="w-3 h-3"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="flex-1 flex flex-col h-full overflow-y-auto hidden">
        <header class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center sticky top-0 z-10 no-print">
            <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
            <div class="text-sm text-slate-500" id="current-date"></div>
        </header>

        <div id="content-area" class="p-8 max-w-7xl mx-auto w-full">
            <!-- Dynamic Content Injected Here -->
        </div>
    </main>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 z-50 flex items-center gap-3">
        <i data-lucide="check-circle" class="text-green-400 w-5 h-5"></i>
        <span id="toast-msg">Operation successful</span>
    </div>

    <!-- SCRIPTS -->
    <script>
        // --- CONFIGURATION ---
        const MASTER_CREDENTIALS = {
            user: "dante.frota@d2hvacsolutions.com",
            pass: "!D2hvac!2025"
        };
        
        // --- FIREBASE INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyDeX6K21E7LaQ1FPlI6rKuPVJEzscGDzxo",
            authDomain: "d2-hvac-w9.firebaseapp.com",
            projectId: "d2-hvac-w9",
            storageBucket: "d2-hvac-w9.firebasestorage.app",
            messagingSenderId: "536339640292",
            appId: "1:536339640292:web:807253b2ec9ac41f93e1f1"
        };

        const activeConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        firebase.initializeApp(activeConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let storage = null;
        try {
            if(activeConfig.storageBucket) {
                storage = firebase.storage();
            }
        } catch(e) { console.warn("Storage warning:", e); }

        // --- STATE ---
        let contractors = [];
        let payments = [];
        let appUsers = [];
        let listeners = [];
        let isPublicMode = false;

        // --- INITIALIZATION ---
        
        // Check for Public Link Mode
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'onboard') {
            isPublicMode = true;
            initPublicMode();
        } else {
            // Setup Login Listeners
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        async function initPublicMode() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('public-onboard-view').classList.remove('hidden');
            lucide.createIcons();
            
            // Auto sign-in anonymously to allow writing to DB
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                 await auth.signInAnonymously();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('login-error');
            const btn = document.getElementById('btn-login');

            btn.textContent = "Verifying...";
            btn.disabled = true;

            try {
                // 1. Authenticate with Firebase first (Anon) to read DB
                if (!auth.currentUser) {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                }

                // 2. Check Master Creds
                if (email === MASTER_CREDENTIALS.user && pass === MASTER_CREDENTIALS.pass) {
                    grantAccess();
                    return;
                }

                // 3. Check DB Users
                const isAIPreview = typeof __app_id !== 'undefined';
                const usersCollection = isAIPreview 
                    ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users')
                    : db.collection('app_users');
                
                const snapshot = await usersCollection.where('email', '==', email).where('password', '==', btoa(pass)).get();
                
                if (!snapshot.empty) {
                    grantAccess();
                } else {
                    throw new Error("Invalid Credentials");
                }

            } catch (err) {
                console.error(err);
                errorDiv.textContent = "Invalid email or password.";
                errorDiv.classList.remove('hidden');
                btn.textContent = "Sign In";
                btn.disabled = false;
            }
        }

        function grantAccess() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            initApp();
        }

        function logout() {
            window.location.reload();
        }

        // --- DATA FETCHING ---
        function initApp() {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const isAIPreview = typeof __app_id !== 'undefined';
            
            const cCollection = isAIPreview 
                ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('contractors')
                : db.collection('contractors'); 
            const pCollection = isAIPreview
                ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('payments')
                : db.collection('payments'); 
            const uCollection = isAIPreview
                ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users')
                : db.collection('app_users');

            listeners.push(cCollection.onSnapshot(snap => {
                contractors = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(window.currentView === 'dashboard') renderDashboard();
                if(window.currentView === 'contractors') renderContractors();
                if(window.currentView === 'reports') renderReports();
            }));

            listeners.push(pCollection.onSnapshot(snap => {
                payments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(window.currentView === 'dashboard') renderDashboard();
                if(window.currentView === 'payments') renderPayments();
                if(window.currentView === 'reports') renderReports();
            }));

            listeners.push(uCollection.onSnapshot(snap => {
                appUsers = snap.docs.map(d => ({id: d.id, ...d.data()}));
                if(window.currentView === 'users') renderUsers();
            }));

            router('dashboard');
        }

        // --- ROUTING ---
        window.currentView = 'dashboard';
        function router(view) {
            window.currentView = view;
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                b.classList.add('hover:bg-slate-800');
            });
            const activeBtn = document.getElementById(`nav-${view}`);
            if(activeBtn) {
                activeBtn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                activeBtn.classList.remove('hover:bg-slate-800');
            }

            const titles = { 
                dashboard: 'Overview', 
                contractors: 'Contractor Management', 
                payments: 'Payment Ledger', 
                reports: 'Tax Reports (1099)',
                users: 'User Management' 
            };
            document.getElementById('page-title').textContent = titles[view];
            document.getElementById('content-area').innerHTML = '';
            
            if(view === 'dashboard') renderDashboard();
            if(view === 'contractors') renderContractors();
            if(view === 'payments') renderPayments();
            if(view === 'reports') renderReports();
            if(view === 'users') renderUsers();
            lucide.createIcons();
        }

        // --- FILE HANDLING ---
        async function uploadFile(file) {
            if (storage) {
                try {
                    const storageRef = storage.ref();
                    const fileRef = storageRef.child(`contractors/${Date.now()}_${file.name}`);
                    const snapshot = await fileRef.put(file);
                    return await snapshot.ref.getDownloadURL();
                } catch (e) {
                    alert("Storage Error: " + e.message);
                    console.error(e);
                    throw e;
                }
            }
            if (file.size > 950 * 1024) throw new Error("File too large for database storage. Please setup Firebase Storage.");
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
            });
        }

        // --- PUBLIC FORM LOGIC ---
        async function handlePublicSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-public-submit');
            btn.textContent = "Submitting...";
            btn.disabled = true;

            const fileInput = document.getElementById('pb-file');
            let fileData = null;

            try {
                if(fileInput.files[0]) {
                    fileData = await uploadFile(fileInput.files[0]);
                }

                const isAIPreview = typeof __app_id !== 'undefined';
                const collectionRef = isAIPreview 
                    ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('contractors')
                    : db.collection('contractors');

                await collectionRef.add({
                    businessName: document.getElementById('pb-name').value,
                    contactName: document.getElementById('pb-contact').value,
                    ein: document.getElementById('pb-ein').value,
                    email: document.getElementById('pb-email').value,
                    phone: document.getElementById('pb-phone').value,
                    address: document.getElementById('pb-address').value,
                    w9OnFile: !!fileData,
                    w9File: fileData,
                    createdAt: new Date().toISOString(),
                    source: 'public_link'
                });

                document.getElementById('public-form').classList.add('hidden');
                document.getElementById('public-success').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("Error submitting: " + err.message);
                btn.textContent = "Submit Registration";
                btn.disabled = false;
            }
        }

        // --- CONTRACTOR MODAL LOGIC ---
        function openEditModal(id) {
            const c = contractors.find(x => x.id === id);
            if(!c) return;

            // Populate Fields
            document.getElementById('ec-id').value = c.id;
            document.getElementById('ec-name').value = c.businessName;
            document.getElementById('ec-contact').value = c.contactName || '';
            document.getElementById('ec-ein').value = c.ein;
            document.getElementById('ec-email').value = c.email || '';
            document.getElementById('ec-phone').value = c.phone || '';
            document.getElementById('ec-address').value = c.address;
            document.getElementById('ec-new-file').value = ''; 

            // W9 Section Logic
            if(c.w9OnFile && c.w9File) {
                document.getElementById('ec-current-w9').classList.remove('hidden');
                document.getElementById('ec-no-w9').classList.add('hidden');
                document.getElementById('ec-download-link').href = c.w9File;
            } else {
                document.getElementById('ec-current-w9').classList.add('hidden');
                document.getElementById('ec-no-w9').classList.remove('hidden');
            }

            document.getElementById('edit-c-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-c-modal').classList.add('hidden');
        }

        async function handleUpdateContractor(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-update-c');
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> Saving...`;
            btn.disabled = true;
            lucide.createIcons();

            const id = document.getElementById('ec-id').value;
            const fileInput = document.getElementById('ec-new-file');
            
            const isAIPreview = typeof __app_id !== 'undefined';
            const collectionRef = isAIPreview 
                ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('contractors')
                : db.collection('contractors');

            try {
                const updateData = {
                    businessName: document.getElementById('ec-name').value,
                    contactName: document.getElementById('ec-contact').value,
                    ein: document.getElementById('ec-ein').value,
                    email: document.getElementById('ec-email').value,
                    phone: document.getElementById('ec-phone').value,
                    address: document.getElementById('ec-address').value,
                };

                // Handle new file upload
                if(fileInput.files[0]) {
                    const url = await uploadFile(fileInput.files[0]);
                    updateData.w9OnFile = true;
                    updateData.w9File = url;
                }

                await collectionRef.doc(id).update(updateData);
                closeEditModal();
                showToast("Contractor Updated Successfully");
            } catch(err) {
                console.error(err);
                alert("Error updating: " + err.message);
            } finally {
                btn.innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Save Changes`;
                btn.disabled = false;
                lucide.createIcons();
            }
        }

        async function handleDeleteFromModal() {
            const id = document.getElementById('ec-id').value;
            if(confirm("Are you sure? This cannot be undone.")){
                 const isAIPreview = typeof __app_id !== 'undefined';
                const collectionRef = isAIPreview 
                    ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('contractors')
                    : db.collection('contractors');
                
                await collectionRef.doc(id).delete();
                closeEditModal();
                showToast("Contractor Deleted");
            }
        }

        // --- USER MANAGEMENT LOGIC ---
        async function handleAddUser(e) {
            e.preventDefault();
            const email = document.getElementById('nu-email').value;
            const pass = document.getElementById('nu-pass').value;

            if(!email || !pass) return alert("All fields required");

            const isAIPreview = typeof __app_id !== 'undefined';
            const uCollection = isAIPreview 
                ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users')
                : db.collection('app_users');

            try {
                // Simple Obfuscation for this level of app
                await uCollection.add({
                    email: email,
                    password: btoa(pass), // Basic Base64 encoding
                    createdAt: new Date().toISOString()
                });
                document.getElementById('nu-email').value = '';
                document.getElementById('nu-pass').value = '';
                showToast("User Added Successfully");
            } catch(err) {
                console.error(err);
                alert("Error adding user: " + err.message);
            }
        }

        async function deleteUser(id) {
             if(confirm("Remove this user's access?")){
                 const isAIPreview = typeof __app_id !== 'undefined';
                 const uCollection = isAIPreview 
                    ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users')
                    : db.collection('app_users');
                 await uCollection.doc(id).delete();
                 showToast("User Removed");
             }
        }

        // --- VIEWS ---
        function renderDashboard() {
            const container = document.getElementById('content-area');
            const totalC = contractors.length;
            const year = new Date().getFullYear();
            const ytd = payments.filter(p => p.date.startsWith(year)).reduce((acc, curr) => acc + (parseFloat(curr.amount)||0), 0);
            const w9Count = contractors.filter(c => c.w9OnFile).length;
            const recentP = [...payments].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Contractors Card -->
                    <div onclick="router('contractors')" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition-all flex items-center gap-4 group">
                        <div class="p-4 bg-blue-100 text-blue-600 rounded-full group-hover:scale-110 transition-transform"><i data-lucide="users"></i></div>
                        <div><p class="text-sm text-slate-500 font-bold uppercase">Contractors</p><h3 class="text-3xl font-bold text-slate-800">${totalC}</h3></div>
                    </div>
                    
                    <!-- Payments Card -->
                    <div onclick="router('payments')" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-green-300 transition-all flex items-center gap-4 group">
                        <div class="p-4 bg-green-100 text-green-600 rounded-full group-hover:scale-110 transition-transform"><i data-lucide="dollar-sign"></i></div>
                        <div><p class="text-sm text-slate-500 font-bold uppercase">YTD Payout (${year})</p><h3 class="text-3xl font-bold text-slate-800">$${ytd.toLocaleString()}</h3></div>
                    </div>

                    <!-- Reports/W9 Card -->
                    <div onclick="router('reports')" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-purple-300 transition-all flex items-center gap-4 group">
                        <div class="p-4 bg-purple-100 text-purple-600 rounded-full group-hover:scale-110 transition-transform"><i data-lucide="file-check"></i></div>
                        <div><p class="text-sm text-slate-500 font-bold uppercase">W9s on File</p><h3 class="text-3xl font-bold text-slate-800">${w9Count} / ${totalC}</h3></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">Recent Transactions</h3>
                        <div class="space-y-3">
                            ${recentP.length ? recentP.map(p => {
                                const c = contractors.find(cx => cx.id === p.contractorId) || {businessName: 'Unknown'};
                                return `<div class="flex justify-between items-center p-3 hover:bg-slate-50 rounded-lg border border-transparent hover:border-slate-100 transition-all">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs border border-slate-200">${c.businessName.substring(0,2).toUpperCase()}</div>
                                            <div><p class="font-bold text-slate-800 text-sm">${c.businessName}</p><p class="text-xs text-slate-500">${p.date}</p></div>
                                        </div>
                                        <span class="font-bold text-slate-700">$${parseFloat(p.amount).toLocaleString()}</span>
                                    </div>`;
                            }).join('') : '<p class="text-slate-400 text-center py-4">No payments yet.</p>'}
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-8 text-white flex flex-col justify-center items-center text-center shadow-xl">
                        <img src="logo-D2-HVAC-Solutions-preto.png" class="w-24 mb-4 bg-white p-2 rounded-lg opacity-90" onerror="this.style.display='none'">
                        <h2 class="text-2xl font-bold mb-2">D2 HVAC Admin</h2>
                        <p class="text-slate-400 mb-6 max-w-xs text-sm">Welcome back, Dante. Your system is secure and ready for tax season.</p>
                        <div class="flex gap-2 text-xs"><span class="bg-slate-700 px-3 py-1 rounded-full">Secure Mode</span><span class="bg-blue-900 text-blue-200 px-3 py-1 rounded-full">v3.0 PRO</span></div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        function copyLink() {
            const url = window.location.href.split('?')[0] + "?mode=onboard";
            navigator.clipboard.writeText(url).then(() => {
                showToast("Link Copied to Clipboard!");
            }).catch(err => {
                prompt("Copy this link manually:", url);
            });
        }

        function renderContractors() {
            const container = document.getElementById('content-area');
            container.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between mb-6 no-print gap-4">
                    <div class="relative w-full max-w-sm">
                        <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                        <input type="text" id="c-search" onkeyup="filterContractors()" placeholder="Search contractors..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyLink()" class="bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm transition-colors">
                            <i data-lucide="share-2" class="w-4 h-4"></i> Share Onboarding Link
                        </button>
                        <button onclick="showAddContractorModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-sm transition-colors">
                            <i data-lucide="plus"></i> Add Contractor
                        </button>
                    </div>
                </div>
                <div id="add-c-form" class="hidden bg-blue-50 border border-blue-200 p-6 rounded-xl mb-6">
                    <h3 class="font-bold text-blue-900 mb-4">New Contractor Registration</h3>
                    <form onsubmit="handleSaveContractor(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="nc-name" placeholder="Business Name *" required class="p-2 rounded border border-slate-300">
                        <input type="text" id="nc-contact" placeholder="Contact Person" class="p-2 rounded border border-slate-300">
                        <input type="text" id="nc-ein" placeholder="EIN / SSN *" required class="p-2 rounded border border-slate-300">
                        <input type="email" id="nc-email" placeholder="Email" class="p-2 rounded border border-slate-300">
                        <input type="text" id="nc-phone" placeholder="Phone" class="p-2 rounded border border-slate-300">
                        <input type="text" id="nc-address" placeholder="Full Address *" required class="p-2 rounded border border-slate-300">
                        <div class="md:col-span-2 bg-white p-3 rounded border border-dashed border-slate-400">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Upload W9 (Photo or PDF)</label>
                            <input type="file" id="nc-file" accept="image/*,.pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                            <p class="text-[10px] text-slate-400 mt-1">${storage ? "Secure Cloud Storage Active. Large PDFs supported." : "Storage not configured. Max 1MB limit active."}</p>
                        </div>
                        <div class="md:col-span-2 flex justify-end gap-2 mt-2">
                            <button type="button" onclick="document.getElementById('add-c-form').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-white rounded">Cancel</button>
                            <button type="submit" id="btn-save-c" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Save Record</button>
                        </div>
                    </form>
                </div>
                <div id="c-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>`;
            filterContractors(); 
            lucide.createIcons();
        }

        function filterContractors() {
            const query = document.getElementById('c-search')?.value.toLowerCase() || '';
            const list = document.getElementById('c-list');
            if(!list) return;

            const filtered = contractors.filter(c => c.businessName.toLowerCase().includes(query) || c.ein.includes(query));
            list.innerHTML = filtered.map(c => `
                <div onclick="openEditModal('${c.id}')" class="cursor-pointer bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition-all flex flex-col justify-between group relative">
                    <div class="absolute top-4 right-4 text-slate-300 group-hover:text-blue-500 transition-colors">
                        <i data-lucide="pencil" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <div class="flex items-center gap-2 mb-2 pr-6">
                            <h3 class="font-bold text-lg text-slate-800">${c.businessName}</h3>
                            ${c.w9OnFile ? '<i data-lucide="file-check" class="w-4 h-4 text-green-500"></i>' : ''}
                        </div>
                        <div class="space-y-1 text-sm text-slate-500">
                            <p><span class="font-mono bg-slate-100 px-1 rounded text-xs text-slate-600">${c.ein}</span></p>
                            <p>${c.contactName}</p>
                            <p class="truncate">${c.email}</p>
                        </div>
                    </div>
                    <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center text-xs text-slate-400">
                        <span class="truncate max-w-[150px]">${c.address}</span>
                        <span class="text-blue-600 font-semibold group-hover:underline">View Details</span>
                    </div>
                </div>`).join('');
            
            if(filtered.length === 0) list.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400 bg-slate-50 rounded border border-dashed border-slate-300">No contractors found matching "${query}"</div>`;
            lucide.createIcons();
        }

        async function handleSaveContractor(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-c');
            btn.textContent = "Uploading & Saving...";
            btn.disabled = true;

            const fileInput = document.getElementById('nc-file');
            let fileData = null;
            try {
                if(fileInput.files[0]) fileData = await uploadFile(fileInput.files[0]);
                const isAIPreview = typeof __app_id !== 'undefined';
                const collectionRef = isAIPreview ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('contractors') : db.collection('contractors');

                await collectionRef.add({
                    businessName: document.getElementById('nc-name').value,
                    contactName: document.getElementById('nc-contact').value,
                    ein: document.getElementById('nc-ein').value,
                    email: document.getElementById('nc-email').value,
                    phone: document.getElementById('nc-phone').value,
                    address: document.getElementById('nc-address').value,
                    w9OnFile: !!fileData,
                    w9File: fileData,
                    createdAt: new Date().toISOString()
                });
                document.getElementById('add-c-form').classList.add('hidden');
                e.target.reset();
                showToast("Contractor Registered");
            } catch (err) { alert("Error: " + err.message); } 
            finally { btn.textContent = "Save Record"; btn.disabled = false; }
        }

        function renderPayments() {
            const container = document.getElementById('content-area');
            const sorted = [...payments].sort((a,b) => new Date(b.date) - new Date(a.date));
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 sticky top-6">
                            <h2 class="font-bold text-lg mb-4 text-slate-800">Log Payment</h2>
                            <form onsubmit="handleSavePayment(event)" class="space-y-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Contractor</label>
                                    <select id="np-contractor" required class="w-full p-2 bg-white border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"><option value="">Select...</option>${contractors.map(c => `<option value="${c.id}">${c.businessName}</option>`).join('')}</select>
                                </div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Amount ($)</label><input type="number" step="0.01" id="np-amount" required class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Date</label><input type="date" id="np-date" required class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" value="${new Date().toISOString().split('T')[0]}"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Method</label>
                                    <select id="np-method" class="w-full p-2 bg-white border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                                        <option>Check</option>
                                        <option>ACH</option>
                                        <option>Zelle</option>
                                        <option>Cash</option>
                                        <option>Credit Card</option>
                                    </select>
                                </div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Memo</label><input type="text" id="np-memo" placeholder="Invoice #..." class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"></div>
                                <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 shadow-sm">Record Payment</button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-slate-50 text-slate-500 border-b border-slate-200"><tr><th class="px-4 py-3 font-semibold">Date</th><th class="px-4 py-3 font-semibold">Payee</th><th class="px-4 py-3 font-semibold">Details</th><th class="px-4 py-3 font-semibold text-right">Amount</th></tr></thead>
                                <tbody class="divide-y divide-slate-100">${sorted.map(p => { const c = contractors.find(cx => cx.id === p.contractorId) || {businessName: 'Unknown'}; return `<tr class="hover:bg-slate-50"><td class="px-4 py-3 font-mono text-slate-600">${p.date}</td><td class="px-4 py-3 font-bold text-slate-800">${c.businessName}</td><td class="px-4 py-3 text-slate-500"><span class="bg-slate-100 px-2 py-0.5 rounded text-xs border border-slate-200">${p.method}</span>${p.description ? `<span class="ml-2 text-xs opacity-75">${p.description}</span>` : ''}</td><td class="px-4 py-3 text-right font-bold text-slate-700">$${parseFloat(p.amount).toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`; }).join('')}${sorted.length === 0 ? '<tr><td colspan="4" class="p-8 text-center text-slate-400">No records found.</td></tr>' : ''}</tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        async function handleSavePayment(e) {
            e.preventDefault();
            const isAIPreview = typeof __app_id !== 'undefined';
            const collectionRef = isAIPreview ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('payments') : db.collection('payments');
            await collectionRef.add({
                contractorId: document.getElementById('np-contractor').value,
                amount: parseFloat(document.getElementById('np-amount').value),
                date: document.getElementById('np-date').value,
                method: document.getElementById('np-method').value,
                description: document.getElementById('np-memo').value,
                createdAt: new Date().toISOString()
            });
            e.target.reset();
            document.getElementById('np-date').value = new Date().toISOString().split('T')[0];
            showToast("Payment Recorded");
        }

        function renderReports() {
            const container = document.getElementById('content-area');
            const currentYear = new Date().getFullYear();
            const reportData = [];
            contractors.forEach(c => {
                const total = payments.filter(p => p.contractorId === c.id && p.date.startsWith(currentYear)).reduce((sum, p) => sum + parseFloat(p.amount), 0);
                if (total > 0) reportData.push({ ...c, total });
            });
            reportData.sort((a,b) => b.total - a.total);
            const grandTotal = reportData.reduce((acc, c) => acc + c.total, 0);

            container.innerHTML = `
                <div class="print-header mb-8 text-center hidden"><img src="logo-D2-HVAC-Solutions-preto.png" class="w-32 mx-auto mb-4" onerror="this.style.display='none'"><h1 class="text-3xl font-bold text-slate-900 mb-2">D2 HVAC Solutions</h1><p class="text-slate-600">Contractor Payment Summary (1099 Data)</p><p class="text-sm text-slate-500">Tax Year: ${currentYear}</p></div>
                <div class="flex flex-col sm:flex-row justify-between items-end gap-4 mb-6 no-print"><div><h2 class="text-2xl font-bold text-slate-800">1099 Report (${currentYear})</h2><p class="text-slate-500">Contractors with activity this year.</p></div><button onclick="window.print()" class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg transition-all"><i data-lucide="printer"></i> Print Report / Save PDF</button></div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden card">
                    <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center"><span class="font-bold text-slate-700">TOTAL OUTFLOW</span><span class="font-bold text-xl text-slate-900">$${grandTotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</span></div>
                    <table class="w-full text-left text-sm">
                        <thead class="bg-white text-slate-500 border-b border-slate-200"><tr><th class="px-6 py-4 font-bold uppercase text-xs tracking-wider">Contractor Entity</th><th class="px-6 py-4 font-bold uppercase text-xs tracking-wider">Tax ID (EIN)</th><th class="px-6 py-4 font-bold uppercase text-xs tracking-wider text-center">W9 Status</th><th class="px-6 py-4 font-bold uppercase text-xs tracking-wider text-right">Total Paid</th></tr></thead>
                        <tbody class="divide-y divide-slate-100">
                            ${reportData.map(r => `<tr class="${r.total >= 600 ? 'bg-red-50/50' : ''}"><td class="px-6 py-4"><p class="font-bold text-slate-800 text-base">${r.businessName}</p><p class="text-xs text-slate-500">${r.address}</p></td><td class="px-6 py-4 font-mono text-slate-600">${r.ein}</td><td class="px-6 py-4 text-center">${r.w9OnFile ? '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700">Active</span>' : '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-bold bg-red-100 text-red-700">MISSING</span>'}</td><td class="px-6 py-4 text-right"><p class="font-bold text-slate-800 text-base">$${r.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</p>${r.total >= 600 ? '<p class="text-[10px] text-red-500 font-bold uppercase tracking-wide">1099 Required</p>' : ''}</td></tr>`).join('')}
                            ${reportData.length === 0 ? '<tr><td colspan="4" class="p-12 text-center text-slate-400">No payment activity recorded for this year.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>`;
            lucide.createIcons();
        }

        function renderUsers() {
            const container = document.getElementById('content-area');
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><i data-lucide="user-plus" class="w-5 h-5"></i> Add Authorized User</h2>
                        <form onsubmit="handleAddUser(event)" class="space-y-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Email</label><input type="email" id="nu-email" required class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase">Password</label><input type="password" id="nu-pass" required class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"></div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 shadow-sm">Create User</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">Current Authorized Users</h2>
                        <div class="space-y-2">
                             <div class="flex justify-between items-center p-3 bg-slate-50 rounded border border-slate-100">
                                <div><p class="font-bold text-slate-800">Master Admin</p><p class="text-xs text-slate-500">dante.frota@d2hvacsolutions.com</p></div>
                                <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">System Owner</span>
                            </div>
                            ${appUsers.map(u => `
                                <div class="flex justify-between items-center p-3 bg-white rounded border border-slate-200 hover:border-blue-300 transition-colors">
                                    <div><p class="font-bold text-slate-800">Authorized User</p><p class="text-xs text-slate-500">${u.email}</p></div>
                                    <button onclick="deleteUser('${u.id}')" class="text-red-400 hover:text-red-600 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            `).join('')}
                            ${appUsers.length === 0 ? '<p class="text-slate-400 text-sm italic">No additional users created yet.</p>' : ''}
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // --- UTILS ---
        function showAddContractorModal() { document.getElementById('add-c-form').classList.remove('hidden'); document.getElementById('nc-name').focus(); }
        function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').textContent = msg; t.classList.remove('translate-y-20'); setTimeout(() => t.classList.add('translate-y-20'), 3000); }
    </script>
</body>
</html>