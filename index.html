<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D2 HVAC Solutions - Contractor Manager</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-storage-compat.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* PRINT STYLES */
        @media print {
            @page { margin: 1.5cm; size: auto; }
            body { background: white; color: black; }
            #sidebar, #login-screen, .no-print, #edit-c-modal, #user-modal, #public-onboard-view, #mobile-overlay, #mobile-menu-btn { display: none !important; }
            #main-content { margin: 0; padding: 0; width: 100%; height: auto; overflow: visible; }
            .card { box-shadow: none; border: none; }
            table { width: 100%; border-collapse: collapse; font-size: 11px; }
            thead { display: table-header-group; }
            tr { page-break-inside: avoid; }
            th { background-color: #f3f4f6 !important; color: #000 !important; font-weight: bold; border-bottom: 1px solid #000; padding: 8px 4px; text-align: left; -webkit-print-color-adjust: exact; }
            td { border-bottom: 1px solid #ddd; padding: 8px 4px; }
            .print-header { display: flex !important; flex-direction: column; align-items: center; justify-content: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px; }
            .print-logo { max-height: 80px; width: auto; margin-bottom: 10px; }
            .print-title { font-size: 24px; font-weight: bold; text-transform: uppercase; color: #000; }
            .print-meta { font-size: 12px; color: #444; margin-top: 5px; }
            .total-row { font-weight: bold; background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; }
        }
        .print-header { display: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 font-sans h-screen flex overflow-hidden relative">

    <!-- MOBILE OVERLAY BACKDROP -->
    <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-slate-900/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- PUBLIC ONBOARDING VIEW -->
    <div id="public-onboard-view" class="fixed inset-0 z-[60] bg-slate-100 overflow-y-auto hidden">
        <div class="min-h-screen flex flex-col items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-6 sm:p-8 border border-slate-200">
                <div class="flex flex-col items-center mb-8 border-b border-slate-100 pb-6">
                    <img src="logo-D2-HVAC-Solutions-preto.png" alt="D2 HVAC Logo" class="w-32 sm:w-40 mb-4 object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="w-16 h-16 bg-blue-600 rounded-xl hidden items-center justify-center text-white mx-auto">
                        <i data-lucide="building-2" class="w-10 h-10"></i>
                    </div>
                    <h1 class="text-xl sm:text-2xl font-bold text-slate-800 mt-4 text-center">Contractor Registration</h1>
                    <p class="text-slate-500 text-center mt-2 text-sm">Please fill out your business details and attach your W-9 form.</p>
                </div>
                <form id="public-form" onsubmit="handlePublicSubmit(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="pb-name" required placeholder="Business Name *" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <input type="text" id="pb-contact" placeholder="Contact Person" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <input type="text" id="pb-ein" required placeholder="EIN / SSN *" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50 font-mono">
                        <input type="email" id="pb-email" placeholder="Email Address" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <input type="text" id="pb-phone" placeholder="Phone Number" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                        <input type="text" id="pb-address" required placeholder="Mailing Address *" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                        <label class="block text-sm font-bold text-blue-900 mb-3">Upload W-9 Form</label>
                        <input type="file" id="pb-file" accept="image/*,.pdf" class="block w-full text-sm text-slate-500 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-blue-600 file:text-white hover:file:bg-blue-700 cursor-pointer bg-white rounded-lg border border-blue-100">
                    </div>
                    <button type="submit" id="btn-public-submit" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-black shadow-lg">Submit Registration</button>
                </form>
                <div id="public-success" class="hidden text-center py-12">
                    <h2 class="text-2xl font-bold text-slate-800 mb-2">Registration Successful!</h2>
                    <p class="text-slate-500">Thank you. Your information has been securely received.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <div class="flex flex-col items-center mb-6">
                <div class="w-32 mb-6">
                    <img src="logo-D2-HVAC-Solutions-preto.png" alt="D2 HVAC Logo" class="w-full h-auto object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="w-16 h-16 bg-blue-600 rounded-xl hidden items-center justify-center text-white mx-auto">
                        <i data-lucide="building-2" class="w-10 h-10"></i>
                    </div>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 text-center">Contractor Management</h1>
                <p class="text-slate-500 text-sm mt-1">Payment & Compliance Control</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="relative">
                    <label class="sr-only">Email</label>
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                        <i data-lucide="mail" class="w-5 h-5"></i>
                    </div>
                    <input type="email" id="email" autocapitalize="none" autocomplete="email" class="w-full pl-10 pr-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="Email" required>
                </div>
                <div class="relative">
                    <label class="sr-only">Password</label>
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                        <i data-lucide="lock" class="w-5 h-5"></i>
                    </div>
                    <input type="password" id="password" autocapitalize="none" class="w-full pl-10 pr-12 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="Password" required>
                    <button type="button" onclick="toggleLoginPassword()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400 hover:text-blue-600 transition-colors z-10 cursor-pointer" style="min-width: 40px; justify-content: center;">
                        <i id="icon-show" data-lucide="eye" class="w-5 h-5"></i>
                        <i id="icon-hide" data-lucide="eye-off" class="w-5 h-5 hidden"></i>
                    </button>
                </div>
                <div id="login-error" class="text-red-500 text-sm text-center hidden bg-red-50 p-2 rounded">Invalid credentials.</div>
                <button type="submit" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-lg active:scale-95">Sign In</button>
            </form>
            <div class="mt-6 text-center text-xs text-slate-400">Â© 2026 D2 HVAC Solutions</div>
        </div>
    </div>

    <!-- ADD/EDIT USER MODAL -->
    <div id="user-modal" class="fixed inset-0 z-50 bg-slate-900/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
            <h3 id="um-title" class="font-bold text-xl text-slate-800 mb-4">Manage User</h3>
            <form onsubmit="handleSaveUser(event)" class="space-y-4">
                <input type="hidden" id="um-id">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Name</label>
                    <input type="text" id="um-name" required class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g. John Doe">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Email</label>
                    <input type="email" id="um-email" required class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="text" id="um-pass" required class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" placeholder="New Password">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Role</label>
                    <select id="um-role" onchange="toggleContractorSelect()" class="w-full p-2 bg-white border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="admin">Admin (Full Access)</option>
                        <option value="employee">Employee (No User Mgmt)</option>
                        <option value="contractor">Contractor (Limited View)</option>
                    </select>
                </div>
                <div id="um-contractor-div" class="hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Link to Contractor Profile</label>
                    <select id="um-contractor-link" class="w-full p-2 bg-white border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">Select Contractor...</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeUserModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- EDIT CONTRACTOR MODAL -->
    <div id="edit-c-modal" class="fixed inset-0 z-40 bg-slate-900/50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 text-blue-600 p-2 rounded-lg"><i data-lucide="user-cog" class="w-6 h-6"></i></div>
                    <div><h3 class="font-bold text-xl text-slate-800">Contractor Details</h3><p class="text-xs text-slate-500">Edit information</p></div>
                </div>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-slate-600 p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <form id="edit-c-form" onsubmit="handleUpdateContractor(event)" class="p-6 space-y-5">
                <input type="hidden" id="ec-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="ec-name" required placeholder="Business Name" class="w-full p-2 border rounded">
                    <input type="text" id="ec-contact" placeholder="Contact Person" class="w-full p-2 border rounded">
                    <input type="text" id="ec-ein" required placeholder="EIN" class="w-full p-2 border rounded bg-slate-50 font-mono">
                    <input type="email" id="ec-email" placeholder="Email" class="w-full p-2 border rounded">
                    <input type="text" id="ec-phone" placeholder="Phone" class="w-full p-2 border rounded">
                    <input type="text" id="ec-address" required placeholder="Address" class="w-full p-2 border rounded">
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-3">W-9 Management</label>
                    <div id="ec-current-w9" class="flex items-center gap-4 mb-4 bg-white p-3 rounded-lg border border-slate-200 hidden">
                        <i data-lucide="file-text" class="text-red-500"></i>
                        <span class="text-sm font-bold flex-1">File On Record</span>
                        <a id="ec-download-link" target="_blank" class="text-blue-600 text-xs font-bold hover:underline">Download</a>
                    </div>
                    <div id="ec-no-w9" class="text-sm text-slate-500 mb-4 hidden px-2">No W-9 on file.</div>
                    <input type="file" id="ec-new-file" accept="image/*,.pdf" class="block w-full text-xs text-slate-500">
                </div>
                <div class="flex justify-between pt-4 border-t border-slate-100">
                    <button type="button" onclick="handleDeleteFromModal()" class="text-red-500 text-sm font-bold flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete</button>
                    <div class="flex gap-2">
                        <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">Cancel</button>
                        <button type="submit" id="btn-update-c" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Save</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- SIDEBAR NAVIGATION -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-slate-300 flex flex-col transform transition-transform duration-300 -translate-x-full md:translate-x-0 md:static md:h-screen hidden">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
             <div class="w-10 h-10 bg-white rounded-lg p-1 flex items-center justify-center">
                <img src="logo-D2-HVAC-Solutions-preto.png" alt="Logo" class="max-w-full max-h-full" onerror="this.style.display='none'; this.parentElement.innerHTML='<i data-lucide=\'building-2\' class=\'text-blue-600\'></i>'">
            </div>
            <div>
                <h1 class="font-bold text-white leading-tight">D2 HVAC</h1>
                <p id="user-role-display" class="text-[10px] text-blue-400 uppercase tracking-widest font-bold">Loading...</p>
            </div>
        </div>

        <nav id="nav-container" class="flex-1 p-4 space-y-2 overflow-y-auto">
            <!-- Nav Items Injected via JS -->
        </nav>

        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3 mb-4">
                <div id="user-initials-display" class="w-8 h-8 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center font-bold text-xs uppercase">
                    <i data-lucide="user"></i>
                </div>
                <div>
                    <p id="user-name-display" class="text-xs font-bold text-white truncate w-32">User</p>
                    <p class="text-[10px] text-slate-500">Logged In</p>
                </div>
            </div>
            <button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-xs text-red-400 hover:text-red-300 transition-colors">
                <i data-lucide="log-out" class="w-3 h-3"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="flex-1 flex flex-col h-full overflow-y-auto hidden bg-slate-100">
        <header class="bg-white border-b border-slate-200 px-4 md:px-8 py-4 flex justify-between items-center sticky top-0 z-20 no-print shadow-sm">
            <div class="flex items-center gap-3">
                <!-- MOBILE MENU BUTTON -->
                <button onclick="toggleMobileMenu()" class="md:hidden text-slate-500 hover:text-slate-800 p-1">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h2 id="page-title" class="text-lg md:text-xl font-bold text-slate-800 truncate">Dashboard</h2>
            </div>
            <div class="text-xs md:text-sm text-slate-500" id="current-date"></div>
        </header>
        <div id="content-area" class="p-4 md:p-8 max-w-7xl mx-auto w-full"></div>
    </main>

    <div id="toast" class="fixed bottom-4 right-4 bg-slate-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 z-[70] flex items-center gap-3">
        <i data-lucide="check-circle" class="text-green-400 w-5 h-5"></i>
        <span id="toast-msg">Success</span>
    </div>

    <!-- SCRIPTS -->
    <script>
        const MASTER_CREDENTIALS = { user: "dante.frota@d2hvacsolutions.com", pass: "!D2hvac!2025", name: "Dante Frota" };
        
        const firebaseConfig = {
            apiKey: "AIzaSyDeX6K21E7LaQ1FPlI6rKuPVJEzscGDzxo",
            authDomain: "d2-hvac-w9.firebaseapp.com",
            projectId: "d2-hvac-w9",
            storageBucket: "d2-hvac-w9.firebasestorage.app",
            messagingSenderId: "536339640292",
            appId: "1:536339640292:web:807253b2ec9ac41f93e1f1"
        };
        const activeConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        firebase.initializeApp(activeConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let storage = null;
        try { if(activeConfig.storageBucket) storage = firebase.storage(); } catch(e) { console.warn(e); }

        let contractors = [];
        let payments = [];
        let appUsers = [];
        let currentUser = null; 
        let isPublicMode = false;

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'onboard') {
            isPublicMode = true;
            initPublicMode();
        } else {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            lucide.createIcons();
        }

        async function initPublicMode() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('public-onboard-view').classList.remove('hidden');
            lucide.createIcons();
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token);
            else await auth.signInAnonymously();
        }

        function toggleLoginPassword() {
            const pwdInput = document.getElementById('password');
            const showIcon = document.getElementById('icon-show');
            const hideIcon = document.getElementById('icon-hide');
            if (pwdInput.type === "password") {
                pwdInput.type = "text";
                showIcon.classList.add('hidden');
                hideIcon.classList.remove('hidden');
            } else {
                pwdInput.type = "password";
                showIcon.classList.remove('hidden');
                hideIcon.classList.add('hidden');
            }
        }

        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const emailInput = document.getElementById('email').value.trim();
            const email = emailInput.toLowerCase(); 
            const pass = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('login-error');
            const btn = document.getElementById('btn-login');

            btn.textContent = "Verifying...";
            btn.disabled = true;
            errorDiv.classList.add('hidden');

            try {
                if (!auth.currentUser) {
                     try {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                             await auth.signInWithCustomToken(__initial_auth_token);
                         } else {
                             await auth.signInAnonymously();
                         }
                     } catch(authErr) {
                         console.error("Auth Error:", authErr);
                         throw new Error("Connection failed. Please refresh.");
                     }
                }

                let isAuthenticated = false;
                let userRole = 'employee';
                let userName = 'User';
                let userId = 'db_user';
                let linkedId = null;

                if (email === MASTER_CREDENTIALS.user.toLowerCase() && pass === MASTER_CREDENTIALS.pass) {
                    isAuthenticated = true;
                    userRole = 'admin';
                    userId = 'master';
                    userName = MASTER_CREDENTIALS.name;
                } 
                
                if (!isAuthenticated) {
                    const isAIPreview = typeof __app_id !== 'undefined';
                    const usersCollection = isAIPreview 
                        ? db.collection('artifacts').doc(appId).collection('public').doc('data').collection('app_users') 
                        : db.collection('app_users');
                    
                    const snapshot = await usersCollection.get();
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.email && data.email.toLowerCase() === email && data.password === btoa(pass)) {
                            isAuthenticated = true;
                            userId = doc.id;
                            userRole = data.role || 'employee';
                            userName = data.name || 'Authorized User';
                            linkedId = data.linkedContractorId;
                        }
                    });
                }

                if (isAuthenticated) {
                    currentUser = { email: email, role: userRole, id: userId, name: userName, linkedContractorId: linkedId };
                    if(userRole === 'contractor' && !userName && linkedId) currentUser.name = "Contractor"; 
                    grantAccess();
                } else {
                    throw new Error("Invalid Credentials");
                }

            } catch (err) {
                console.error("Login Flow Error:", err);
                errorDiv.textContent = err.message === "Invalid Credentials" ? "Invalid email or password." : ("Error: " + err.message);
                errorDiv.classList.remove('hidden');
                btn.textContent = "Sign In";
                btn.disabled = false;
            }
        }

        function grantAccess() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            
            document.getElementById('user-name-display').textContent = currentUser.name || currentUser.email;
            document.getElementById('user-role-display').textContent = (currentUser.role || 'employee').toUpperCase();
            
            const name = currentUser.name || "User";
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            document.getElementById('user-initials-display').textContent = initials;

            initApp();
        }

        function logout() { window.location.reload(); }

        function initApp() {
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const isAIPreview = typeof __app_id !== 'undefined';
            const root = isAIPreview ? db.collection('artifacts').doc(appId).collection('public').doc('data') : db;
            
            root.collection('contractors').onSnapshot(s => {
                contractors = s.docs.map(d => ({id: d.id, ...d.data()}));
                if (currentUser && currentUser.role === 'contractor' && currentUser.linkedContractorId) {
                    const linked = contractors.find(c => c.id === currentUser.linkedContractorId);
                    if (linked && linked.contactName) {
                        currentUser.name = linked.contactName;
                        document.getElementById('user-name-display').textContent = currentUser.name;
                        const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                        document.getElementById('user-initials-display').textContent = initials;
                    }
                }
                refreshCurrentView();
            });
            root.collection('payments').onSnapshot(s => {
                payments = s.docs.map(d => ({id: d.id, ...d.data()}));
                refreshCurrentView();
            });
            
            if(currentUser && currentUser.role === 'admin') {
                root.collection('app_users').onSnapshot(s => {
                    appUsers = s.docs.map(d => ({id: d.id, ...d.data()}));
                    if(window.currentView === 'users') renderUsers();
                });
            }

            buildNavigation();
            router(currentUser.role === 'contractor' ? 'my-profile' : 'dashboard');
        }

        function buildNavigation() {
            const nav = document.getElementById('nav-container');
            nav.innerHTML = '';
            const role = currentUser.role || 'employee';

            const createBtn = (id, icon, label) => `<button onclick="router('${id}'); if(window.innerWidth < 768) toggleMobileMenu();" id="nav-${id}" class="nav-btn w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-slate-800 transition-all text-slate-300"><i data-lucide="${icon}" class="w-5 h-5"></i> ${label}</button>`;

            if (role !== 'contractor') {
                nav.innerHTML += createBtn('dashboard', 'layout-dashboard', 'Dashboard');
                nav.innerHTML += createBtn('contractors', 'users', 'Contractors');
                nav.innerHTML += createBtn('payments', 'dollar-sign', 'Payments');
                nav.innerHTML += createBtn('reports', 'file-bar-chart', 'Financial Reports');
            } else {
                nav.innerHTML += createBtn('my-profile', 'user', 'My Profile');
            }

            if (role === 'admin') {
                nav.innerHTML += createBtn('users', 'user-plus', 'Users & Access');
            }
            lucide.createIcons();
        }

        function router(view) {
            window.currentView = view;
            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'shadow-lg');
                b.classList.add('hover:bg-slate-800', 'text-slate-300');
            });
            const activeBtn = document.getElementById(`nav-${view}`);
            if(activeBtn) {
                activeBtn.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
                activeBtn.classList.remove('hover:bg-slate-800', 'text-slate-300');
            }

            const titles = { dashboard: 'Overview', contractors: 'Contractor Management', payments: 'Payment Ledger', reports: 'Financial Reports', users: 'User Access Control', 'my-profile': 'My Contractor Portal' };
            document.getElementById('page-title').textContent = titles[view] || view;
            refreshCurrentView();
        }

        function refreshCurrentView() {
            const container = document.getElementById('content-area');
            container.innerHTML = '';
            const view = window.currentView;
            if(view === 'dashboard') renderDashboard();
            else if(view === 'contractors') renderContractors();
            else if(view === 'payments') renderPayments();
            else if(view === 'reports') renderReports();
            else if(view === 'users') renderUsers();
            else if(view === 'my-profile') renderContractorPortal();
            lucide.createIcons();
        }

        // --- RENDERERS ---
        function renderDashboard() {
             const container = document.getElementById('content-area');
            const totalC = contractors.length;
            const year = new Date().getFullYear();
            const ytd = payments.filter(p => p.date.startsWith(year)).reduce((acc, curr) => acc + (parseFloat(curr.amount)||0), 0);
            const w9Count = contractors.filter(c => c.w9OnFile).length;
            const recentP = [...payments].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5);

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8">
                    <div onclick="router('contractors')" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all flex items-center gap-4 group">
                        <div class="p-4 bg-blue-100 text-blue-600 rounded-full"><i data-lucide="users"></i></div>
                        <div><p class="text-sm text-slate-500 font-bold uppercase">Contractors</p><h3 class="text-3xl font-bold text-slate-800">${totalC}</h3></div>
                    </div>
                    <div onclick="router('payments')" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all flex items-center gap-4 group">
                        <div class="p-4 bg-green-100 text-green-600 rounded-full"><i data-lucide="dollar-sign"></i></div>
                        <div><p class="text-sm text-slate-500 font-bold uppercase">YTD Payout</p><h3 class="text-3xl font-bold text-slate-800">$${ytd.toLocaleString()}</h3></div>
                    </div>
                    <div onclick="router('reports')" class="cursor-pointer bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all flex items-center gap-4 group">
                        <div class="p-4 bg-purple-100 text-purple-600 rounded-full"><i data-lucide="file-check"></i></div>
                        <div><p class="text-sm text-slate-500 font-bold uppercase">W9s on File</p><h3 class="text-3xl font-bold text-slate-800">${w9Count} / ${totalC}</h3></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 text-slate-800">Recent Transactions</h3>
                        <div class="space-y-3">
                            ${recentP.length ? recentP.map(p => { const c = contractors.find(cx => cx.id === p.contractorId) || {businessName: 'Unknown'}; return `<div class="flex justify-between items-center p-3 hover:bg-slate-50 rounded-lg border border-transparent hover:border-slate-100 transition-all"><div class="flex items-center gap-3"><div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs border border-slate-200">${c.businessName.substring(0,2).toUpperCase()}</div><div><p class="font-bold text-slate-800 text-xs md:text-sm">${c.businessName}</p><p class="text-[10px] md:text-xs text-slate-500">${p.date}</p></div></div><span class="font-bold text-slate-700 text-sm md:text-base">$${parseFloat(p.amount).toLocaleString()}</span></div>`; }).join('') : '<p class="text-slate-400 text-center py-4">No payments yet.</p>'}
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-8 text-white flex flex-col justify-center items-center text-center shadow-xl">
                        <img src="logo-D2-HVAC-Solutions-preto.png" class="w-24 mb-4 bg-white p-2 rounded-lg opacity-90" onerror="this.style.display='none'">
                        <h2 class="text-xl md:text-2xl font-bold mb-2">Welcome Back, ${currentUser.name.split(' ')[0]}</h2>
                        <p class="text-slate-400 mb-6 max-w-xs text-xs md:text-sm">System is secure and up to date.</p>
                        <div class="flex gap-2 text-[10px] md:text-xs"><span class="bg-slate-700 px-3 py-1 rounded-full">Secure Mode</span><span class="bg-blue-900 text-blue-200 px-3 py-1 rounded-full">v4.1 Fixes</span></div>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        function renderContractors() {
             const container = document.getElementById('content-area');
            container.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between mb-6 no-print gap-4">
                    <div class="relative w-full max-w-sm">
                        <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-slate-400"></i>
                        <input type="text" id="c-search" onkeyup="filterContractors()" placeholder="Search contractors..." class="pl-10 pr-4 py-2 w-full rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm md:text-base">
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="copyLink()" class="flex-1 sm:flex-none bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 px-3 py-2 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm transition-colors text-xs md:text-sm"><i data-lucide="share-2" class="w-4 h-4"></i> Link</button>
                        <button onclick="showAddContractorModal()" class="flex-1 sm:flex-none bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg font-bold flex items-center justify-center gap-2 shadow-sm transition-colors text-xs md:text-sm"><i data-lucide="plus"></i> Add</button>
                    </div>
                </div>
                <div id="add-c-form" class="hidden bg-blue-50 border border-blue-200 p-4 md:p-6 rounded-xl mb-6">
                    <h3 class="font-bold text-blue-900 mb-4">New Contractor Registration</h3>
                    <form onsubmit="handleSaveContractor(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="nc-name" placeholder="Business Name *" required class="p-2 rounded border border-slate-300 w-full">
                        <input type="text" id="nc-contact" placeholder="Contact Person" class="p-2 rounded border border-slate-300 w-full">
                        <input type="text" id="nc-ein" placeholder="EIN / SSN *" required class="p-2 rounded border border-slate-300 w-full">
                        <input type="email" id="nc-email" placeholder="Email" class="p-2 rounded border border-slate-300 w-full">
                        <input type="text" id="nc-phone" placeholder="Phone" class="p-2 rounded border border-slate-300 w-full">
                        <input type="text" id="nc-address" placeholder="Full Address *" required class="p-2 rounded border border-slate-300 w-full">
                        <div class="md:col-span-2 bg-white p-3 rounded border border-dashed border-slate-400"><label class="block text-xs font-bold text-slate-500 uppercase mb-2">Upload W9</label><input type="file" id="nc-file" accept="image/*,.pdf" class="block w-full text-sm text-slate-500"></div>
                        <div class="md:col-span-2 flex justify-end gap-2 mt-2"><button type="button" onclick="document.getElementById('add-c-form').classList.add('hidden')" class="px-4 py-2 text-slate-600 hover:bg-white rounded">Cancel</button><button type="submit" id="btn-save-c" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Save</button></div>
                    </form>
                </div>
                <div id="c-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>`;
            filterContractors(); 
            lucide.createIcons();
        }

        function filterContractors() {
            const query = document.getElementById('c-search')?.value.toLowerCase() || '';
            const list = document.getElementById('c-list');
            if(!list) return;
            const filtered = contractors.filter(c => c.businessName.toLowerCase().includes(query) || c.ein.includes(query));
            list.innerHTML = filtered.map(c => `
                <div onclick="openEditModal('${c.id}')" class="cursor-pointer bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:shadow-md transition-all flex flex-col justify-between group relative">
                    <div class="absolute top-4 right-4 text-slate-300 group-hover:text-blue-500 transition-colors"><i data-lucide="pencil" class="w-4 h-4"></i></div>
                    <div><div class="flex items-center gap-2 mb-2 pr-6"><h3 class="font-bold text-lg text-slate-800">${c.businessName}</h3>${c.w9OnFile ? '<i data-lucide="file-check" class="w-4 h-4 text-green-500"></i>' : ''}</div><div class="space-y-1 text-sm text-slate-500"><p><span class="font-mono bg-slate-100 px-1 rounded text-xs text-slate-600">${c.ein}</span></p><p>${c.contactName}</p></div></div>
                    <div class="mt-4 pt-3 border-t border-slate-100 flex justify-between items-center text-xs text-slate-400"><span class="truncate max-w-[150px]">${c.address}</span><span class="text-blue-600 font-semibold group-hover:underline">View</span></div>
                </div>`).join('');
            if(filtered.length === 0) list.innerHTML = `<div class="col-span-full py-12 text-center text-slate-400 bg-slate-50 rounded border border-dashed border-slate-300">No contractors found.</div>`;
            lucide.createIcons();
        }

        function renderPayments() {
             const container = document.getElementById('content-area');
            const sorted = [...payments].sort((a,b) => new Date(b.date) - new Date(a.date));
            const today = new Date().toISOString().split('T')[0];
            
            container.innerHTML = `
                <div class="print-header mb-8 text-center hidden"><img src="logo-D2-HVAC-Solutions-preto.png" class="w-32 mx-auto mb-4" onerror="this.style.display='none'"><h1 class="text-3xl font-bold text-slate-900 mb-2">D2 HVAC Solutions</h1><p class="text-slate-600">Payment Ledger</p></div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 no-print">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 sticky top-6">
                            <h2 class="font-bold text-lg mb-4 text-slate-800">Log Payment</h2>
                            <form onsubmit="handleSavePayment(event)" class="space-y-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Contractor</label><select id="np-contractor" required class="w-full p-2 bg-white border border-slate-300 rounded"><option value="">Select...</option>${contractors.map(c => `<option value="${c.id}">${c.businessName}</option>`).join('')}</select></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Amount ($)</label><input type="number" step="0.01" id="np-amount" required class="w-full p-2 border border-slate-300 rounded"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Date</label><input type="date" id="np-date" required class="w-full p-2 border border-slate-300 rounded" value="${today}"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Method</label><select id="np-method" class="w-full p-2 bg-white border border-slate-300 rounded"><option>Check</option><option>ACH</option><option>Zelle</option><option>Cash</option><option>Credit Card</option></select></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase">Memo</label><input type="text" id="np-memo" placeholder="Invoice #..." class="w-full p-2 border border-slate-300 rounded"></div>
                                <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 shadow-sm">Record Payment</button>
                            </form>
                        </div>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <div class="p-4 border-b border-slate-200 bg-slate-50 flex flex-col sm:flex-row gap-4 items-end no-print">
                                <div class="flex-1 w-full">
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Filter Contractor</label>
                                    <select id="l-contractor" onchange="filterLedger()" class="w-full p-1.5 text-sm border rounded"><option value="">All Contractors</option>${contractors.map(c => `<option value="${c.id}">${c.businessName}</option>`).join('')}</select>
                                </div>
                                <div class="w-full sm:w-auto">
                                    <button onclick="window.print()" class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-3 py-1.5 rounded-lg font-bold flex items-center justify-center gap-2 transition-colors shadow-sm"><i data-lucide="printer" class="w-4 h-4"></i> Print</button>
                                </div>
                            </div>
                            <div id="ledger-table-container" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>`;
            window.filterLedger();
            lucide.createIcons();
        }

        window.filterLedger = () => {
            const filterC = document.getElementById('l-contractor').value;
            const filtered = payments.filter(p => !filterC || p.contractorId === filterC).sort((a,b) => new Date(b.date) - new Date(a.date));
            const html = `
                <table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 text-slate-500 border-b"><tr><th class="px-4 py-3">Date</th><th class="px-4 py-3">Payee</th><th class="px-4 py-3">Details</th><th class="px-4 py-3 text-right">Amount</th></tr></thead><tbody class="divide-y divide-slate-100">${filtered.map(p => { const c = contractors.find(cx => cx.id === p.contractorId) || {businessName: 'Unknown'}; return `<tr class="hover:bg-slate-50"><td class="px-4 py-3 font-mono text-slate-600">${p.date}</td><td class="px-4 py-3 font-bold text-slate-800">${c.businessName}</td><td class="px-4 py-3 text-slate-500"><span class="bg-slate-100 px-2 py-0.5 rounded text-xs border border-slate-200">${p.method}</span>${p.description ? `<span class="ml-2 text-xs opacity-75">${p.description}</span>` : ''}</td><td class="px-4 py-3 text-right font-bold text-slate-700">$${parseFloat(p.amount).toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`; }).join('')}${filtered.length === 0 ? '<tr><td colspan="4" class="p-8 text-center text-slate-400">No records found.</td></tr>' : ''}</tbody></table>`;
            document.getElementById('ledger-table-container').innerHTML = html;
        };

        function renderReports() {
            const container = document.getElementById('content-area');
            const today = new Date().toISOString().split('T')[0];
            const startOfYear = new Date().getFullYear() + '-01-01';
            container.innerHTML = `
                <div class="no-print bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6"><div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Start Date</label><input type="date" id="rep-start" value="${startOfYear}" class="w-full p-2 border rounded border-slate-300"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">End Date</label><input type="date" id="rep-end" value="${today}" class="w-full p-2 border rounded border-slate-300"></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Contractor</label><select id="rep-contractor" class="w-full p-2 bg-white border rounded border-slate-300"><option value="all">All Contractors (Summary)</option>${contractors.map(c => `<option value="${c.id}">${c.businessName}</option>`).join('')}</select></div><div class="flex gap-2"><button onclick="generateReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold flex items-center justify-center gap-2 flex-1"><i data-lucide="filter"></i> Generate</button><button onclick="window.print()" class="bg-slate-800 hover:bg-black text-white px-4 py-2 rounded font-bold flex items-center justify-center gap-2 flex-1"><i data-lucide="printer"></i> Print</button></div></div></div><div id="report-output"></div>`;
            generateReport(); 
            lucide.createIcons();
        }

        function generateReport() {
            const start = document.getElementById('rep-start').value;
            const end = document.getElementById('rep-end').value;
            const contractorId = document.getElementById('rep-contractor').value;
            const output = document.getElementById('report-output');
            const filteredPayments = payments.filter(p => p.date >= start && p.date <= end && (contractorId === 'all' || p.contractorId === contractorId)).sort((a,b) => new Date(a.date) - new Date(b.date));
            let printHeaderHtml = `<div class="print-header"><img src="logo-D2-HVAC-Solutions-preto.png" class="print-logo" onerror="this.style.display='none'"><div class="print-title">D2 HVAC SOLUTIONS</div><div class="print-meta">Report Period: ${start} to ${end}</div></div>`;
            let tableHtml = '';
            let totalSum = 0;

            if (contractorId === 'all') {
                const summary = {};
                filteredPayments.forEach(p => {
                    if(!summary[p.contractorId]) {
                        const c = contractors.find(x => x.id === p.contractorId) || {businessName: 'Unknown', ein: 'N/A'};
                        summary[p.contractorId] = { name: c.businessName, ein: c.ein, total: 0, count: 0, w9: c.w9OnFile };
                    }
                    summary[p.contractorId].total += parseFloat(p.amount);
                    summary[p.contractorId].count++;
                });
                const sortedSummary = Object.values(summary).sort((a,b) => b.total - a.total);
                totalSum = sortedSummary.reduce((acc, curr) => acc + curr.total, 0);
                tableHtml = `<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden card"><div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 text-slate-500 border-b"><tr><th class="px-6 py-3">Contractor Name</th><th class="px-6 py-3">EIN / Tax ID</th><th class="px-6 py-3 text-center">W9 Status</th><th class="px-6 py-3 text-center">Transactions</th><th class="px-6 py-3 text-right">Total Paid</th></tr></thead><tbody class="divide-y divide-slate-100">${sortedSummary.map(row => `<tr><td class="px-6 py-3 font-bold text-slate-700">${row.name}</td><td class="px-6 py-3 font-mono text-slate-500">${row.ein}</td><td class="px-6 py-3 text-center">${row.w9 ? '<span class="text-green-600 font-bold">OK</span>' : '<span class="text-red-500 font-bold">MISSING</span>'}</td><td class="px-6 py-3 text-center text-slate-500">${row.count}</td><td class="px-6 py-3 text-right font-bold text-slate-800">$${row.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`).join('')}<tr class="bg-slate-100 total-row border-t-2 border-slate-300"><td colspan="4" class="px-6 py-3 text-right font-bold uppercase text-slate-700">Grand Total</td><td class="px-6 py-3 text-right font-bold text-black text-lg">$${totalSum.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr></tbody></table></div></div>`;
            } else {
                const c = contractors.find(x => x.id === contractorId) || {businessName: 'Unknown', ein: 'N/A', address: ''};
                totalSum = filteredPayments.reduce((acc, p) => acc + parseFloat(p.amount), 0);
                printHeaderHtml += `<div class="no-print mb-4 p-4 bg-blue-50 border border-blue-100 rounded-lg"><h3 class="font-bold text-lg text-blue-900">${c.businessName}</h3><p class="text-sm text-blue-700">EIN: ${c.ein} | ${c.address}</p></div><div class="print-header" style="display:none; text-align: left !important; align-items: flex-start !important; margin-top: 10px; border-bottom: none;"><strong>Contractor:</strong> ${c.businessName}<br><strong>EIN:</strong> ${c.ein}<br><strong>Address:</strong> ${c.address}</div>`;
                tableHtml = `<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden card"><div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 text-slate-500 border-b"><tr><th class="px-6 py-3">Date</th><th class="px-6 py-3">Method</th><th class="px-6 py-3">Description / Memo</th><th class="px-6 py-3 text-right">Amount</th></tr></thead><tbody class="divide-y divide-slate-100">${filteredPayments.map(p => `<tr><td class="px-6 py-3 font-mono text-slate-600">${p.date}</td><td class="px-6 py-3"><span class="bg-slate-100 px-2 py-1 rounded text-xs border border-slate-200">${p.method}</span></td><td class="px-6 py-3 text-slate-500">${p.description || '-'}</td><td class="px-6 py-3 text-right font-bold text-slate-700">$${parseFloat(p.amount).toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>`).join('')}<tr class="bg-slate-100 total-row border-t-2 border-slate-300"><td colspan="3" class="px-6 py-3 text-right font-bold uppercase text-slate-700">Total Paid</td><td class="px-6 py-3 text-right font-bold text-black text-lg">$${totalSum.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr></tbody></table></div></div>`;
            }
            output.innerHTML = printHeaderHtml + tableHtml;
            if(filteredPayments.length === 0) output.innerHTML += `<div class="p-8 text-center text-slate-400 bg-slate-50 rounded border border-dashed mt-4">No records found for this period.</div>`;
        }

        function renderUsers() {
            const container = document.getElementById('content-area');
            container.innerHTML = `<div class="flex justify-between items-center mb-6"><p class="text-slate-500 text-sm md:text-base">Manage access levels and reset passwords.</p><button onclick="openUserModal()" class="bg-blue-600 text-white px-3 py-2 text-sm md:text-base md:px-4 md:py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-blue-700 shadow-sm"><i data-lucide="plus"></i> New User</button></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-slate-50 text-slate-500 border-b"><tr><th class="px-6 py-3">Name</th><th class="px-6 py-3">Email</th><th class="px-6 py-3">Role</th><th class="px-6 py-3 text-right">Actions</th></tr></thead><tbody class="divide-y divide-slate-100">${appUsers.map(u => { const roleColors = { admin: 'bg-purple-100 text-purple-700', employee: 'bg-blue-100 text-blue-700', contractor: 'bg-green-100 text-green-700' }; return `<tr class="hover:bg-slate-50"><td class="px-6 py-3 font-bold text-slate-700">${u.name || 'User'}</td><td class="px-6 py-3 text-slate-500">${u.email}</td><td class="px-6 py-3"><span class="${roleColors[u.role] || 'bg-gray-100'} px-2 py-1 rounded text-xs font-bold">${u.role ? u.role.toUpperCase() : 'EMPLOYEE'}</span></td><td class="px-6 py-3 text-right flex justify-end gap-2"><button onclick='openUserModal(${JSON.stringify(u).replace(/'/g, "&apos;")})' class="text-blue-500 hover:bg-blue-50 p-2 rounded"><i data-lucide="key" class="w-4 h-4"></i></button><button onclick="deleteUser('${u.id}')" class="text-red-500 hover:bg-red-50 p-2 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td></tr>`; }).join('')}</tbody></table></div></div>`;
            lucide.createIcons();
        }

        function renderContractorPortal() {
            const container = document.getElementById('content-area');
            const cId = currentUser.linkedContractorId;
            const myProfile = contractors.find(c => c.id === cId);
            if(!myProfile) return container.innerHTML = `<div class="text-center p-10">Profile not linked. Contact Admin.</div>`;
            const myPayments = payments.filter(p => p.contractorId === cId).sort((a,b) => new Date(b.date) - new Date(a.date));
            const totalPaid = myPayments.reduce((acc, p) => acc + parseFloat(p.amount), 0);
            container.innerHTML = `<div class="print-header mb-8 text-center hidden"><img src="logo-D2-HVAC-Solutions-preto.png" class="w-32 mx-auto mb-4" onerror="this.style.display='none'"><h1 class="text-3xl font-bold text-slate-900 mb-2">D2 HVAC Solutions</h1><p class="text-slate-600">Contractor Statement</p></div><div class="mb-6 no-print"><h2 class="text-xl md:text-2xl font-bold text-slate-800">Welcome, ${currentUser.name || myProfile.contactName}</h2><p class="text-slate-500">Your contractor portal</p></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 no-print"><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p class="text-sm text-slate-500 font-bold uppercase">Total Earnings</p><h3 class="text-3xl font-bold text-green-600">$${totalPaid.toLocaleString()}</h3></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p class="text-sm text-slate-500 font-bold uppercase">Business Info</p><h3 class="font-bold text-slate-800">${myProfile.businessName}</h3><p class="text-xs text-slate-500">${myProfile.ein}</p></div><div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><p class="text-sm text-slate-500 font-bold uppercase">W-9 Status</p>${myProfile.w9OnFile ? `<div class="flex items-center gap-2 text-green-600 font-bold mt-1"><i data-lucide="check-circle"></i> On File</div>` : `<div class="flex items-center gap-2 text-red-500 font-bold mt-1"><i data-lucide="alert-circle"></i> Missing</div>`}</div></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8"><div class="p-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center no-print"><h3 class="font-bold text-slate-700">My Payment History</h3><button onclick="window.print()" class="text-sm text-blue-600 hover:underline flex items-center gap-1"><i data-lucide="printer" class="w-4 h-4"></i> Print</button></div><div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap"><thead class="bg-white text-slate-500 border-b"><tr><th class="px-6 py-3">Date</th><th class="px-6 py-3">Method</th><th class="px-6 py-3">Memo</th><th class="px-6 py-3 text-right">Amount</th></tr></thead><tbody class="divide-y divide-slate-100">${myPayments.map(p => `<tr><td class="px-6 py-3 font-mono text-slate-600">${p.date}</td><td class="px-6 py-3"><span class="bg-slate-100 px-2 py-1 rounded text-xs">${p.method}</span></td><td class="px-6 py-3 text-slate-500">${p.description || '-'}</td><td class="px-6 py-3 text-right font-bold text-slate-700">$${parseFloat(p.amount).toLocaleString()}</td></tr>`).join('')}</tbody></table></div></div>`;
            lucide.createIcons();
        }

        function showAddContractorModal() {
            const form = document.getElementById('add-c-form');
            form.classList.remove('hidden');
            const nameInput = document.getElementById('nc-name');
            nameInput.focus();
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function copyLink() {
            const url = window.location.href.split('?')[0] + "?mode=onboard";
            navigator.clipboard.writeText(url).then(() => showToast("Copied!")).catch(() => prompt("Link:", url));
        }
        function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').textContent = msg; t.classList.remove('translate-y-20'); setTimeout(() => t.classList.add('translate-y-20'), 3000); }
        async function uploadFile(file) {
            if (storage) {
                const storageRef = storage.ref();
                const fileRef = storageRef.child(`contractors/${Date.now()}_${file.name}`);
                const snapshot = await fileRef.put(file);
                return await snapshot.ref.getDownloadURL();
            }
            if (file.size > 950 * 1024) throw new Error("File too large. Setup Storage.");
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
            });
        }
    </script>
</body>
</html>